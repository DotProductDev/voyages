{% load i18n %}

<div id="tabs-tables-control">
    <div class="row">
      <div class="col-md-6 col-sm-12 col-lg-3">
        <v-dropdown title="{% trans 'Row' %}" description="{% trans '' %}" @changed="updateTabOptions" :options="tabs[enslavedDataset].tables.row.options" :variable="tabs[enslavedDataset].tables.row" :clearable="false"></v-dropdown>
        </div>
      <div class="col-md-6 col-sm-12 col-lg-3">
        <v-dropdown title="{% trans 'Column' %}" description="{% trans '' %}" @changed="updateTabOptions" :options="tabs[enslavedDataset].tables.column.options" :variable="tabs[enslavedDataset].tables.column" :clearable="false"></v-dropdown>
      </div>
      <div class="col-md-6 col-sm-12 col-lg-3">
        <v-dropdown title="{% trans 'Cell' %}" description="{% trans '' %}" @changed="updateTabOptions" :options="tabs[enslavedDataset].tables.cell.options" :variable="tabs[enslavedDataset].tables.cell" :clearable="false"></v-dropdown>
      </div>
      <table id="v-tables" class="table table-striped table-bordered nowrap" cellspacing="0" width="100%" >
        <thead>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
        </tfoot>
      </table>
  
    </div>
  </div>

  <script type="text/javascript">
    const updateTable = async () => {
        if (searchBar.currentTab !== 'tables') {
            return;
        }
        // Fetch data.
        const dataset = parseInt(searchBar.enslavedDataset);
        const defProps = ["sourceVarName", "varName"];
        const getField = (f, props) => {
          const src = searchBar.tabs[enslavedDataset].tables[f];
          const sel = src.value;
          const matches = src.options.filter(o => o.id === sel);
          if (matches.length !== 1) {
            return null;
          }
          props = props || defProps;
          const match = matches[0];
          for (const p of props) {
            if (match[p] != null) {
              return match[p];
            }
          }
          return null;
        };
        const colField = getField('column');
        if (!colField) {
          alert('Cannot build this PivotTable!');
          return;
        }
        const pivot_fields = [getField('row'), colField, getField('cell')]
          .filter(x => !!x);
        const post = {
            search_query: searchAll(searchBar.filter, searchBar.filterData),
            output: 'pivot',
            pivot_fields
        };
        const res = await fetch('/past/api/search_enslaved', {
            method: 'POST',
            body: JSON.stringify(post)
        });
        const data = await res.json();
        const tableId = "#v-tables";
        if ($.fn.dataTable.isDataTable(tableId)) {
            $(tableId).DataTable().destroy();
        }
        const columns = [];
        // Generate columns for the table.
        columns.push({ title: getField('row', ['label']), className: "bold" });
        const nullText = gettext('Null');
        let idxOthersCol = -1;
        let counter = 0;
        let maxCols = getField('column', ['maxResults']) ?? 1000;
        const colIndex = {};
        for (const m of data.margins[colField]) {
          if (++counter > maxCols) {
            idxOthersCol = columns.length;
            columns.push({ title: gettext('Other') });
            break;
          }
          colIndex[m[0]] = columns.length;
          columns.push({ title: m[0] ?? nullText, className: "right" });
        }
        const idxTotalsCol = columns.length;
        columns.push({ title: gettext('Totals'), className: "bold right" });
        const totalsRow = new Array(columns.length);
        totalsRow.fill(0);
        totalsRow[0] = gettext('Totals');
        const rows = { };
        const rowKeySrc = getField('row', ['varName']);
        for (const item of data.results) {
          let rowKey = item[rowKeySrc];
          if (rowKeySrc === 'year_5') {
            rowKey = parseInt(rowKey);
            rowKey = `${rowKey * 5 + 1}-${(rowKey + 1) * 5}`;
          }
          let arr = rows[rowKey];
          if (!arr) {
            arr = new Array(columns.length);
            arr.fill(0);
            arr[0] = rowKey;
            rows[rowKey] = arr;
          }
          const colKey = item[colField];
          let idxCol = colIndex[colKey];
          if (!idxCol) {
            idxCol = idxOthersCol;
          }
          if (idxCol > 0) {
            arr[idxCol] += item.cell;
            totalsRow[idxCol] += item.cell;
          }
          arr[idxTotalsCol] += item.cell;
          totalsRow[idxTotalsCol] += item.cell;
        }
        const dt = $(tableId).DataTable({
            data: Object.values(rows),
            columns,
            paging: false,
            info: false,
            bFilter: false
        });
        let footer = totalsRow.map((c, i) => `<td class="bold${i > 0 ? ' right' : ''}">${c}</td>`).join('');
        $(`${tableId} tfoot`).html(`<tr>${footer}</tr>`);
    };

    document.addEventListener('readystatechange', async () => {
        if (document.readyState === "interactive") {
            await updateTable();
            searchBar.$on('refresh', updateTable);
        }
    });
  </script>